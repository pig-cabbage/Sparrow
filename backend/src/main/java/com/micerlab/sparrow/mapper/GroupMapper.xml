<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.micerlab.sparrow.dao.postgre.GroupDao">
    <insert id="createGroup" parameterType="group">
        insert into spa_group(group_id, group_name, group_desc, creator_id, created_at, personal) values (#{group.group_id},
        #{group.group_name}, #{group.group_desc}, #{group.creator_id}, #{group.created_at}, #{group.personal})
    </insert>
    <select id="getGroupMeta" resultType="group">
        select * from spa_group where group_id = #{group_id}
    </select>
    <select id="getGroupOwnerId" resultType="java.lang.String">
        select creator_id from spa_group where group_id = #{group_id}
    </select>
    <update id="updateGroupMeta">
        update spa_group set group_name = #{group_name} , group_desc = #{group_desc} where group_id = #{group_id}
    </update>
    <delete id="deleteGroup">
        delete from spa_group where group_id = #{group_id}
    </delete>
    <insert id="addMember">
        insert into group_user(group_id, user_id, created_at) values (#{group_id}, #{user_id}, #{created_at})
    </insert>
    <select id="getGroupMembers" resultType="user">
        select u.* from group_user r inner join spa_user u on r.user_id = u.user_id and r.group_id = #{group_id}
    </select>
    <delete id="removeMember">
        delete from group_user where group_id = #{group_id} and user_id = #{user_id}
    </delete>
    <delete id="removeAllMembers">
        delete from group_user where group_id = #{group_id}
    </delete>
    <delete id="removeAllResource">
        delete from group_resource where group_id = #{group_id}
    </delete>
    <select id="getGroupResources" resultType="java.util.Map">
        with r as
        (
          select 'dir' as type, spa_dir.id as id, spa_dir.title as title, spa_dir.thumbnail as thumbnail, spa_dir.creator_id as creator, spa_dir.created_at as created_time from spa_dir
          union all
          select 'doc' as type, spa_doc.id as id, spa_doc.title as title, spa_doc.thumbnail as thumbnail, spa_doc.creator_id as creator, spa_doc.created_at as created_time from spa_doc
        )
        select r.*, group_resource.permission from r inner join group_resource on group_resource.resource_id = r.id and group_resource.group_id = #{group_id}
    </select>
</mapper>